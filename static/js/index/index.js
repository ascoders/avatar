"use strict";define("index",["jquery","editor","jquery.timeago","jquery.autocomplete"],function(e){return avalon.define({$id:"index",categorys:{"全部":-1,"问答":0,"分享":1},lists:[],pagin:"",category:-1,inputTitle:"",inputContent:"",inputCategory:0,tag:!1,addTagInput:"",searchTag:"",hotTags:[],tagArray:[],temp:{editor:{},from:0,number:0,watchCategory:!1},toggleTag:function(){avalon.vmodels.index.tag=!avalon.vmodels.index.tag,e("#index #tag-input").focus()},addTag:function(){return""==avalon.vmodels.index.addTagInput?void notice("标签不能为空","red"):avalon.vmodels.index.addTagInput.length>15?void notice("标签最大长度为15","red"):avalon.vmodels.index.tagArray.size()>=5?void notice("最多5个标签","red"):-1!=e.inArray(avalon.vmodels.index.addTagInput,avalon.vmodels.index.tagArray.$model)?void notice("标签不能重复","red"):(avalon.vmodels.index.tagArray.push(avalon.vmodels.index.addTagInput),avalon.vmodels.index.addTagInput="",void(avalon.vmodels.index.tag=!1))},RemoveTag:function(e){avalon.vmodels.index.tagArray.remove(e)},submit:function(){return avalon.vmodels.global.myLogin?avalon.vmodels.index.inputTitle.length>25?void noticle("标题最长25","red"):avalon.vmodels.index.inputContent.length<3||avalon.vmodels.index.inputContent.length>5e4?void notice("内容长度3-50000","red"):void post("/api/article/add",{title:avalon.vmodels.index.inputTitle,content:avalon.vmodels.index.inputContent,category:avalon.vmodels.index.inputCategory,tag:avalon.vmodels.index.tagArray.$model},"发布成功","",function(e){avalon.vmodels.index.inputTitle="",avalon.vmodels.index.inputContent="",avalon.router.navigate("/art/"+e)}):void avalon.vmodels.global.github()},rendered:function(){e(".timeago").timeago()},onChange:function(e){e.query.from=e.query.from||0,e.query.number=e.query.number||20,e.query.category=e.query.category||-1,avalon.vmodels.index.temp.watchCategory=!1,avalon.vmodels.index.category=e.query.category,avalon.vmodels.index.temp.watchCategory=!0,avalon.vmodels.index.searchTag="";var a="/api/article/list",o={category:e.query.category,from:e.query.from,number:e.query.number};void 0!=e.query.tag&&(avalon.vmodels.index.searchTag=e.query.tag,a="/api/tag/getList",o={from:e.query.from,number:e.query.number,tag:e.query.tag},post("/api/tag/hot",null,null,"",function(e){avalon.vmodels.index.hotTags=e})),post(a,o,null,"获取信息失败：",function(a){var o={};a.members=a.members||[];for(var n=0,t=a.members.length;t>n;n++)o[a.members[n]._id]=a.members[n];for(var i in a.lists){switch(a.lists[i].good=5*a.lists[i].r+a.lists[i].v>100?!0:!1,a.lists[i].c){case 0:a.lists[i]._c="问答";break;case 1:a.lists[i]._c="分享"}a.lists[i].ua=o[a.lists[i].u].a,a.lists[i].ur=o[a.lists[i].u].r,a.lists[i].un=o[a.lists[i].u].n,a.lists[i].ui=o[a.lists[i].u].i,a.lists[i].li=""==a.lists[i].l?"":o[a.lists[i].l].i}avalon.vmodels.index.lists=a.lists||[],avalon.vmodels.index.pagin=createPagin(e.query.from,e.query.number,a.count,{category:e.query.category})})},onAfterLoad:function(){avalon.vmodels.index.temp.editor=new e("#index #editor").MarkEditor(),avalon.vmodels.index.temp.editor.createDom(),avalon.vmodels.index.$watch("category",function(e){avalon.vmodels.index.temp.watchCategory&&avalon.router.go("index",{query:{category:e,from:0}})});var a=e.cookie("_xsrf");if(a){var o=a.split("|"),n=Base64.decode(o[0]);e("#index #tag-input").autocomplete({serviceUrl:"/api/tag/searchTag",type:"post",deferRequestBy:300,params:{_xsrf:n},onSelect:function(e){avalon.vmodels.index.addTagInput=e.value,avalon.vmodels.index.addTag()}})}},$skipArray:["onChange","onAfterLoad","temp"]})});