"use strict";define("article",["jquery","marked","prettify","editor","jquery.timeago","jquery.cookie","jquery.autocomplete"],function(e,a,l){return avalon.define({$id:"article",article:{},replys:[],author:{},hot:[],cold:[],same:[],pagin:"",edit:!1,addTagInput:"",tag:!1,rTag:!1,temp:{editor:null,from:0,number:0,freshSame:function(){post("/api/tag/same",{article:avalon.vmodels.article.article._id},null,"",function(e){for(var a in e)""==e[a].t&&(e[a].t=subStr(e[a].co,0,25)),e[a].Content=e[a].co.replace(/&nbsp;/g,"");avalon.vmodels.article.same=e||[]})}},inputContent:"",submit:function(){if(!avalon.vmodels.global.myLogin)return void avalon.vmodels.global.github();if(avalon.vmodels.article.edit){if(avalon.vmodels.article.inputContent.length<3||avalon.vmodels.article.inputContent.length>5e4)return void notice("文章内容长度3-50000","red")}else if(avalon.vmodels.article.inputContent.length<3||avalon.vmodels.article.inputContent.length>1e4)return void notice("评论内容长度3-10000","red");avalon.vmodels.article.edit?post("/api/article/edit",{id:avalon.vmodels.article.article._id,content:avalon.vmodels.article.inputContent},"更新成功","",function(){avalon.vmodels.article.inputContent="",avalon.router.navigate(window.location.pathname+window.location.search,{reload:!0}),e("html, body").animate({scrollTop:0},300)}):post("/api/article/addReply",{article:avalon.vmodels.article.article._id,content:avalon.vmodels.article.inputContent},"评论成功","",function(){avalon.vmodels.article.inputContent="",avalon.router.navigate("/art/"+avalon.vmodels.article.article._id+"?number="+avalon.vmodels.article.temp.number+"&from="+Math.floor(parseInt(avalon.vmodels.article.article.r)/avalon.vmodels.article.temp.number)*avalon.vmodels.article.temp.number,{reload:!0})})},addTop:function(){0==avalon.vmodels.article.article.tp?post("/api/article/top",{id:avalon.vmodels.article.article._id,top:!0},"已置顶","",function(){avalon.vmodels.article.article.tp=1}):post("/api/article/top",{id:avalon.vmodels.article.article._id,top:!1},"已取消置顶","",function(){avalon.vmodels.article.article.tp=0})},deleteArticle:function(){confirm("删除此文章吗",function(){post("/api/article/delete",{id:avalon.vmodels.article.article._id},"成功删除","",function(){avalon.router.navigate("/")})})},changeEdit:function(){avalon.vmodels.article.edit=!0,avalon.vmodels.article.inputContent=avalon.vmodels.article.article.co,avalon.vmodels.article.temp.editor.freshPreview(),e("html, body").animate({scrollTop:e("#article #editor").offset().top},300)},removeEdit:function(){avalon.vmodels.article.edit=!1,avalon.vmodels.article.inputContent=""},toggleTag:function(){avalon.vmodels.article.tag=!avalon.vmodels.article.tag,e("#article #tag-input").focus()},addTag:function(){return""==avalon.vmodels.article.addTagInput?void notice("标签不能为空","red"):avalon.vmodels.article.addTagInput.length>15?void notice("标签最大长度为15","red"):avalon.vmodels.article.article.ta.size()>=5?void notice("最多5个标签","red"):-1!=e.inArray(avalon.vmodels.article.addTagInput,avalon.vmodels.article.article.ta.$model)?void notice("标签不能重复","red"):void post("/api/tag/bind",{article:avalon.vmodels.article.article._id,name:avalon.vmodels.article.addTagInput},"标签已添加","",function(){avalon.vmodels.article.article.ta.push(avalon.vmodels.article.addTagInput),avalon.vmodels.article.addTagInput="",avalon.vmodels.article.tag=!1,avalon.vmodels.article.temp.freshSame()})},jumpOrRemove:function(e){avalon.vmodels.article.rTag?post("/api/tag/unBind",{article:avalon.vmodels.article.article._id,name:e},"标签已删除","",function(){avalon.vmodels.article.article.ta.remove(e),avalon.vmodels.article.temp.freshSame()}):avalon.router.navigate("/?tag="+e)},toggleRemoveTag:function(){avalon.vmodels.article.rTag=!avalon.vmodels.article.rTag},onChange:function(o){avalon.vmodels.article.edit=!1,avalon.vmodels.article.inputContent="",post("/api/article/article",{id:o.params.id},null,"文章不存在",function(t){t.coHtml=a(t.co),avalon.vmodels.article.article=t,o.query.from=o.query.from||0,o.query.number=o.query.number||20,avalon.vmodels.article.temp.from=o.query.from,avalon.vmodels.article.temp.number=o.query.number,avalon.vmodels.article.pagin=createPagin(o.query.from,o.query.number,t.r);var r=function(a){avalon.vmodels.article.author=a,avalon.nextTick(function(){e(".timeago").timeago(),e("pre").addClass("prettyprint pre-scrollable linenums"),l.prettyPrint()})};avalon.vmodels.article.replys.clear(),post("/api/article/reply",{article:avalon.vmodels.article.article._id,from:o.query.from,number:o.query.number},null,"取评论失败",function(e){var l={};e.member=e.member||[];for(var o=0,t=e.member.length;t>o;o++)l[e.member[o]._id]=e.member[o];for(var r in e.reply)e.reply[r].co=a(e.reply[r].co),e.reply[r].ua=l[e.reply[r].u].a,e.reply[r].ur=l[e.reply[r].u].r,e.reply[r].un=l[e.reply[r].u].n,e.reply[r].ui=l[e.reply[r].u].i;avalon.vmodels.article.replys=e.reply,avalon.vmodels.article.replyMembers=l}),avalon.vmodels.global.temp.users[t.u]?r(avalon.vmodels.global.temp.users[t.u]):post("/api/user/user",{id:t.u},null,"获取作者信息失败",function(e){avalon.vmodels.global.temp.users[t.u]=e,r(e)}),avalon.vmodels.global.temp.userHotCold[t.u]?(avalon.vmodels.article.hot=avalon.vmodels.global.temp.userHotCold[t.u].hot||[],avalon.vmodels.article.cold=avalon.vmodels.global.temp.userHotCold[t.u].cold||[]):post("/api/user/getHotCold",{id:t.u},null,"获取作者文章失败",function(e){avalon.vmodels.global.temp.userHotCold[t.u]=e,avalon.vmodels.article.hot=e.hot||[],avalon.vmodels.article.cold=e.cold||[]}),avalon.vmodels.article.temp.freshSame()},function(){avalon.router.navigate("/404")})},onAfterLoad:function(){avalon.vmodels.article.temp.editor=new e("#article #editor").MarkEditor(),avalon.vmodels.article.temp.editor.createDom();var a=e.cookie("_xsrf");if(a){var l=a.split("|"),o=Base64.decode(l[0]);e("#article #tag-input").autocomplete({serviceUrl:"/api/tag/searchTag",type:"post",deferRequestBy:300,params:{_xsrf:o},onSelect:function(e){avalon.vmodels.article.addTagInput=e.value,avalon.vmodels.article.addTag()}})}},replysRendered:function(){e(".timeago").timeago()},changeCategory:function(e){post("/api/article/changeCategory",{article:avalon.vmodels.article.article._id,category:e},"修改成功","")},$skipArray:["onChange","onAfterLoad","temp"]})});