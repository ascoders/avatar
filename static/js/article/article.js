"use strict";define("article",["jquery","marked","prettify","editor","jquery.timeago","jquery.cookie","jquery.autocomplete"],function(a,e,l){return avalon.define({$id:"article",article:{},replys:[],author:{},hot:[],cold:[],same:[],pagin:"",edit:!1,addTagInput:"",tag:!1,rTag:!1,temp:{editor:null,from:0,number:0,freshSame:function(){post("/api/tag/same",{article:avalon.vmodels.article.article._id},null,"",function(a){for(var e in a)""==a[e].t&&(a[e].t=subStr(a[e].co,0,25)),a[e].Content=a[e].co.replace(/&nbsp;/g,"");avalon.vmodels.article.same=a||[]})}},inputContent:"",submit:function(){if(!avalon.vmodels.global.myLogin)return void avalon.vmodels.global.github();if(avalon.vmodels.article.edit){if(avalon.vmodels.article.inputContent.length<3||avalon.vmodels.article.inputContent.length>5e4)return void notice("文章内容长度3-50000","red")}else if(avalon.vmodels.article.inputContent.length<3||avalon.vmodels.article.inputContent.length>1e4)return void notice("评论内容长度3-10000","red");avalon.vmodels.article.edit?post("/api/article/edit",{id:avalon.vmodels.article.article._id,content:avalon.vmodels.article.inputContent},"更新成功","",function(){avalon.vmodels.article.inputContent="",avalon.router.navigate(window.location.pathname+window.location.search,{reload:!0}),a("html, body").animate({scrollTop:0},300)}):post("/api/article/addReply",{article:avalon.vmodels.article.article._id,content:avalon.vmodels.article.inputContent},"评论成功","",function(){avalon.vmodels.article.inputContent="",avalon.router.navigate("/art/"+avalon.vmodels.article.article._id+"?number="+avalon.vmodels.article.temp.number+"&from="+Math.floor(parseInt(avalon.vmodels.article.article.r)/avalon.vmodels.article.temp.number)*avalon.vmodels.article.temp.number,{reload:!0})})},addTop:function(){0==avalon.vmodels.article.article.tp?post("/api/article/top",{id:avalon.vmodels.article.article._id,top:!0},"已置顶","",function(){avalon.vmodels.article.article.tp=1}):post("/api/article/top",{id:avalon.vmodels.article.article._id,top:!1},"已取消置顶","",function(){avalon.vmodels.article.article.tp=0})},deleteArticle:function(){confirm("删除此文章吗",function(){post("/api/article/delete",{id:avalon.vmodels.article.article._id},"成功删除","",function(){avalon.router.navigate("/")})})},changeEdit:function(){avalon.vmodels.article.edit=!0,avalon.vmodels.article.inputContent=avalon.vmodels.article.article.co,avalon.vmodels.article.temp.editor.freshPreview(),a("html, body").animate({scrollTop:a("#article #editor").offset().top},300)},removeEdit:function(){avalon.vmodels.article.edit=!1,avalon.vmodels.article.inputContent=""},toggleTag:function(){avalon.vmodels.article.tag=!avalon.vmodels.article.tag,a("#article #tag-input").focus()},addTag:function(){return""==avalon.vmodels.article.addTagInput?void notice("标签不能为空","red"):avalon.vmodels.article.addTagInput.length>15?void notice("标签最大长度为15","red"):avalon.vmodels.article.article.ta.size()>=5?void notice("最多5个标签","red"):-1!=a.inArray(avalon.vmodels.article.addTagInput,avalon.vmodels.article.article.ta.$model)?void notice("标签不能重复","red"):void post("/api/tag/bind",{article:avalon.vmodels.article.article._id,name:avalon.vmodels.article.addTagInput},"标签已添加","",function(){avalon.vmodels.article.article.ta.push(avalon.vmodels.article.addTagInput),avalon.vmodels.article.addTagInput="",avalon.vmodels.article.tag=!1,avalon.vmodels.article.temp.freshSame()})},jumpOrRemove:function(a){avalon.vmodels.article.rTag?post("/api/tag/unBind",{article:avalon.vmodels.article.article._id,name:a},"标签已删除","",function(){avalon.vmodels.article.article.ta.remove(a),avalon.vmodels.article.temp.freshSame()}):avalon.router.navigate("/?tag="+a)},toggleRemoveTag:function(){avalon.vmodels.article.rTag=!avalon.vmodels.article.rTag},onChange:function(o){avalon.vmodels.article.edit=!1,avalon.vmodels.article.inputContent="",post("/api/article/article",{id:o.params.id},null,"文章不存在",function(t){t.coHtml=e(t.co),avalon.vmodels.article.article=t,o.query.from=o.query.from||0,o.query.number=o.query.number||20,avalon.vmodels.article.temp.from=o.query.from,avalon.vmodels.article.temp.number=o.query.number,avalon.vmodels.article.pagin=createPagin(o.query.from,o.query.number,t.r);var n=function(e){avalon.vmodels.article.author=e,avalon.nextTick(function(){a(".timeago").timeago(),a("pre").addClass("prettyprint pre-scrollable linenums"),l.prettyPrint()})};avalon.vmodels.article.replys.clear(),post("/api/article/reply",{article:avalon.vmodels.article.article._id,from:o.query.from,number:o.query.number},null,"取评论失败",function(a){for(var l in a)a[l].co=e(a[l].co);avalon.vmodels.article.replys=a}),avalon.vmodels.global.temp.users[t.u]?n(avalon.vmodels.global.temp.users[t.u]):post("/api/user/user",{id:t.u},null,"获取作者信息失败",function(a){avalon.vmodels.global.temp.users[t.u]=a,n(a)}),avalon.vmodels.global.temp.userHotCold[t.u]?(avalon.vmodels.article.hot=avalon.vmodels.global.temp.userHotCold[t.u].hot||[],avalon.vmodels.article.cold=avalon.vmodels.global.temp.userHotCold[t.u].cold||[]):post("/api/user/getHotCold",{id:t.u},null,"获取作者文章失败",function(a){avalon.vmodels.global.temp.userHotCold[t.u]=a,avalon.vmodels.article.hot=a.hot||[],avalon.vmodels.article.cold=a.cold||[]}),avalon.vmodels.article.temp.freshSame()},function(){avalon.router.navigate("/404")})},onAfterLoad:function(){avalon.vmodels.article.temp.editor=new a("#article #editor").MarkEditor(),avalon.vmodels.article.temp.editor.createDom();var e=a.cookie("_xsrf");if(e){var l=e.split("|"),o=Base64.decode(l[0]);a("#article #tag-input").autocomplete({serviceUrl:"/api/tag/searchTag",type:"post",deferRequestBy:300,params:{_xsrf:o},onSelect:function(a){avalon.vmodels.article.addTagInput=a.value,avalon.vmodels.article.addTag()}})}},$skipArray:["onChange","onAfterLoad","temp"]})});