define(["mmHistory"],function(){function t(){var t={};"get,post,delete,put".replace(avalon.rword,function(e){t[e]=[]}),this.routingTable=t}function e(t){var e=t.split("?"),r={},n=e[0],a=e[1];if(a)for(var o,i=a.split("&"),c=i.length,s=0;c>s;s++)i[s]&&(o=i[s].split("="),r[decodeURIComponent(o[0])]=decodeURIComponent(o[1]));return{path:n,query:r}}function r(t){if("string"==typeof t)return t;var e=[];for(var r in t)"query"!=r&&e.push(r+"="+encodeURIComponent(t[r]));return e.length?"?"+e.join("&"):""}function n(t,e,r){var n=t.replace(/[\\\[\]\^$*+?.()|{}]/g,"\\$&");if(!e)return n;var a=r?"?":"";return n+a+"("+e+")"+a}function a(){try{return localStorage.setItem("avalon",1),localStorage.removeItem("avalon"),!0}catch(t){return!1}}function o(t){return String(t).replace(/[,;"\\=\s%]/g,function(t){return encodeURIComponent(t)})}function i(t,e){var r=new Date;r.setTime(r.getTime()+86400),document.cookie=o(t)+"="+o(e)+";expires="+r.toGMTString()}function c(t){var e=String(document.cookie).match(new RegExp("(?:^| )"+t+"(?:(?:=([^;]*))|;|$)"))||["",""];return decodeURIComponent(e[1])}var s=/([:*])(\w+)|\{(\w+)(?:\:((?:[^{}\\]+|\\.|\{(?:[^{}\\]+|\\.)*\})+))?\}/g;return t.prototype={error:function(t){this.errorback=t},_pathToRegExp:function(t,e){for(var r,a,o,i,c=e.keys=[],u="^",p=0;r=s.exec(t);){a=r[2]||r[3],o=r[4]||("*"==r[1]?".*":"string"),i=t.substring(p,r.index);var l=this.$types[o],h={name:a};l&&(o=l.pattern,h.decode=l.decode),c.push(h),u+=n(i,o,!1),p=s.lastIndex}i=t.substring(p),u+=n(i)+(e.strict?e.last:"/?")+"$";var f="boolean"==typeof e.caseInsensitive?e.caseInsensitive:!0;return e.regexp=new RegExp(u,f?"i":void 0),e},add:function(t,e,r,n){var a=this.routingTable[t.toLowerCase()];if("/"!==e.charAt(0))throw"path必须以/开头";n=n||{},n.callback=r,e.length>2&&"/"===e.charAt(e.length-1)&&(e=e.slice(0,-1),n.last="/"),avalon.Array.ensure(a,this._pathToRegExp(e,n))},route:function(t,e,r){e=e.trim();for(var n,a=this.routingTable[t],o=0;n=a[o++];){var i=e.match(n.regexp);if(i){n.query=r||{},n.path=e,n.params={};var c=n.keys;return i.shift(),c.length&&this._parseArgs(i,n),n.callback.apply(n,i)}}this.errorback&&this.errorback()},_parseArgs:function(t,e){for(var r=e.keys,n=0,a=r.length;a>n;n++){var o=r[n],i=t[n]||"";if("function"==typeof o.decode)var c=o.decode(i);else try{c=JSON.parse(i)}catch(s){c=i}t[n]=e.params[o.name]=c}},getLastPath:function(){return c("msLastPath")},setLastPath:function(t){i("msLastPath",t)},navigate:function(t,r){var n=e(("/"!==t.charAt(0)?"/":"")+t),r=r||{};"/"===t.charAt(0)&&(t=t.slice(1)),(!avalon.state||r.silent)&&avalon.history&&avalon.history.updateLocation(t,avalon.mix({},r,{silent:!0})),r.silent||this.route("get",n.path,n.query,r)},when:function(t,e){var r=this,t=t instanceof Array?t:[t];return avalon.each(t,function(t,n){r.add("get",n,function(){var t=r.urlFormate(e,this.params,this.query);r.navigate(t.path+t.query,{replace:!0})})}),this},get:function(){},urlFormate:function(t,e,n){var n=n?r(n):"",a=t.replace(s,function(t){var r=t.replace(/[\{\}]/g,"").split(":");return r=r[0]?r[0]:r[1],e[r]||""}).replace(/^\//g,"");return{path:a,query:n}},$types:{date:{pattern:"[0-9]{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[1-2][0-9]|3[0-1])",decode:function(t){return new Date(t.replace(/\-/g,"/"))}},string:{pattern:"[^\\/]*"},bool:{decode:function(t){return 0===parseInt(t,10)?!1:!0},pattern:"0|1"},"int":{decode:function(t){return parseInt(t,10)},pattern:"\\d+"}}},"get,put,delete,post".replace(avalon.rword,function(e){return t.prototype[e]=function(t,r,n){this.add(e,t,r,n)}}),a()&&(t.prototype.getLastPath=function(){return localStorage.getItem("msLastPath")},t.prototype.setLastPath=function(t){localStorage.setItem("msLastPath",t)}),avalon.router=new t,avalon});