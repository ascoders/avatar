define(["avalon"],function(n){function t(n,t){if("pending"===n._state)if(n._state="fulfilled",t&&"function"==typeof t.then){var e=t instanceof u?"_then":"then";t[e](function(t){i(n,t)},function(t){n._state="rejected",i(n,t)})}else i(n,t)}function e(n,t){"pending"===n._state&&(n._state="rejected",i(n,t))}function i(n,t){n._fired=!0,n._value=t,s(function(){n._callbacks.forEach(function(t){n._fire(t.onSuccess,t.onFail)})})}function o(n,t){t=Array.isArray(t)?t:[];var e,i=0,o=[];return new u(function(r,f){function c(c,u){c.then(function(f){e||(o[u]=f,i++,(n||i>=t.length)&&(r(n?f:o),e=!0))},function(n){e=!0,f(n)})}t.length||r();for(var u=0,s=t.length;s>u;u++)c(t[u],u)})}function r(n){return this.then(n)}function f(n){return this.then(null,n)}var c;if(/native code/.test(window.Promise))c=window.Promise;else{var u=function(n){this._callbacks=[];var i=this;if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof n)throw new TypeError("not a function");n(function(n){t(i,n)},function(n){e(i,n)})},s="function"==typeof window.setImmediate?function(n){window.setImmediate(n)}:function(n){window.setTimeout(n,0)};u.resolve=function(n){return new u(function(t){t(n)})},u.reject=function(n){return new u(function(t,e){e(n)})},u.prototype={constructor:u,_state:"pending",_fired:!1,_fire:function(n,t){if("rejected"===this._state){if("function"!=typeof t)throw this._value;t(this._value)}else"function"==typeof n&&n(this._value)},_then:function(n,t){if(this._fired){var e=this;s(function(){e._fire(n,t)})}else this._callbacks.push({onSuccess:n,onFail:t})},then:function(n,t){var e=this;return new u(function(i,o){e._then(function(t){if("function"==typeof n)try{t=n(t)}catch(e){return void o(e)}i(t)},function(n){if("function"==typeof t){try{n=t(n)}catch(e){return void o(e)}i(n)}else o(n)})})},done:r,"catch":f,fail:f},u.all=function(n){return o(!1,n)},u.race=function(n){return o(!0,n)},c=u}return c.prototype.done=r,c.prototype.fail=f,c.any=c.race,c.defer||(c.defer=function(){var n={};return n.promise=new this(function(t,e){n.resolve=t,n.reject=e}),n}),window.Promise=n.Promise=c});