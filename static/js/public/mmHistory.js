define(["avalon"],function(t){function e(t){return!t||t===window.name||"_self"===t||"top"===t&&window==window.top?!0:!1}function i(t){for(var e,i=0;e=t[i++];)if("A"===e.nodeName)return e}function a(t,e){(e=document.getElementById(t))?e.scrollIntoView():(e=i(document.getElementsByName(t)))?e.scrollIntoView():window.scrollTo(0,0)}var n=document.createElement("a"),o=t.History=function(){this.location=location};o.started=!1,o.IEVersion=function(){var t=document.documentMode;return t?t:window.XMLHttpRequest?7:6}(),o.defaults={basepath:"/",html5Mode:!1,hashPrefix:"!",iframeID:null,interval:50,fireAnchor:!0};var r=window.VBArray&&o.IEVersion<=7,s=!!window.history.pushState,h=!(!("onhashchange"in window)||window.VBArray&&r);return o.prototype={constructor:o,getFragment:function(t){return null==t&&(t="popstate"===this.monitorMode?this.getPath():this.getHash()),t.replace(/^[#\/]|\s+$/g,"")},getHash:function(t){var e=(t||this).location.href;return this._getHash(e.slice(e.indexOf("#")))},_getHash:function(t){return 0===t.indexOf("#/")?decodeURIComponent(t.slice(2)):0===t.indexOf("#!/")?decodeURIComponent(t.slice(3)):""},getPath:function(){var t=decodeURIComponent(this.location.pathname+this.location.search),e=this.basepath.slice(0,-1);return t.indexOf(e)||(t=t.slice(e.length)),t.slice(1)},_getAbsolutePath:function(t){return t.hasAttribute?t.href:t.getAttribute("href",4)},start:function(e){function i(){var t=a.iframe;if("iframepoll"===a.monitorMode&&!t)return!1;var e,i=a.getFragment();if(t){var n=a.getHash(t);i!==a.fragment?(a._setIframeHistory(a.prefix+i),e=i):n!==a.fragment&&(a.location.hash=a.prefix+n,e=n)}else i!==a.fragment&&(e=i);void 0!==e&&(a.fragment=e,a.fireRouteChange(e))}if(o.started)throw new Error("avalon.history has already been started");o.started=!0,this.options=t.mix({},o.defaults,e),this.html5Mode=!!this.options.html5Mode,this.monitorMode=this.html5Mode?"popstate":"hashchange",s||(this.html5Mode&&(t.log("如果浏览器不支持HTML5 pushState，强制使用hash hack!"),this.html5Mode=!1),this.monitorMode="hashchange"),h||(this.monitorMode="iframepoll"),this.prefix="#"+this.options.hashPrefix+"/",this.basepath=("/"+this.options.basepath+"/").replace(/^\/+|\/+$/g,"/"),this.fragment=this.getFragment(),n.href=this.basepath,this.rootpath=this._getAbsolutePath(n);var a=this,r="<!doctype html><html><body>@</body></html>";switch(this.options.domain&&(r=r.replace("<body>","<script>document.domain ="+this.options.domain+"</script><body>")),this.iframeHTML=r,"iframepoll"===this.monitorMode&&t.ready(function(){var t=a.iframe||document.getElementById(a.iframeID)||document.createElement("iframe");t.src="javascript:0",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),a.iframe=t.contentWindow,a._setIframeHistory(a.prefix+a.fragment)}),this.monitorMode){case"popstate":this.checkUrl=t.bind(window,"popstate",i),this._fireLocationChange=i;break;case"hashchange":this.checkUrl=t.bind(window,"hashchange",i);break;case"iframepoll":this.checkUrl=setInterval(i,this.options.interval)}t.ready(function(){a.fireRouteChange(a.fragment||"/",{replace:!0})})},fireRouteChange:function(e,i){var n=t.router;n&&n.navigate&&(n.setLastPath(e),n.navigate("/"===e?e:"/"+e,i)),this.options.fireAnchor&&a(e.replace(/\?.*/g,""))},stop:function(){t.unbind(window,"popstate",this.checkUrl),t.unbind(window,"hashchange",this.checkUrl),clearInterval(this.checkUrl),o.started=!1},updateLocation:function(t,e){var e=e||{},i=e.replace,a=e.silent;if("popstate"===this.monitorMode){var n=this.rootpath+t;n!=this.location.pathname&&history[i?"replaceState":"pushState"]({path:n},document.title,n),a||this._fireLocationChange()}else{var o=this.prefix+t;a&&t!=this.getHash()&&(this._setIframeHistory(o,i),this.fragment=this._getHash(o)),this._setHash(this.location,o,i)}},_setHash:function(t,e,i){var a=t.href.replace(/(javascript:|#).*$/,"");i?t.replace(a+e):t.hash=e},_setIframeHistory:function(t,e){if(this.iframe){var i=this.iframe.document;i.open(),i.write(this.iframeHTML),i.close(),this._setHash(i.location,t,e)}}},t.history=new o,t.bind(document,"click",function(i){var a="defaultPrevented"in i?i.defaultPrevented:i.returnValue===!1;if(!(a||i.ctrlKey||i.metaKey||2===i.which)){for(var n=i.target;"A"!==n.nodeName;)if(n=n.parentNode,!n||"BODY"===n.tagName)return;if(e(n.target)){var o=r?n.getAttribute("href",2):n.getAttribute("href")||n.getAttribute("xlink:href"),s=t.history.prefix;if(null===o)return;var h=o.replace(s,"").trim();0===o.indexOf(s)&&""!==h&&(i.preventDefault(),t.router&&t.router.navigate(h))}}}),t});