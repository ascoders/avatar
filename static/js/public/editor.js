define("editor",["jquery","marked","prettify","jquery.jbox","jquery.selection","jquery.autosize"],function(e,t,s){e.fn.MarkEditor=function(a){var o=e.extend({},e.fn.MarkEditor.defaults,a),r=this;r.wrap("<div class='f-cb edit-box'></div>").addClass("f-w12 f-btn f-mb10");var i=r.parent(),n=e("<div/>").addClass("f-usn").appendTo(i),d=e("<div/>").addClass("f-w12 f-p20 preview border-bottom").appendTo(n),l=e("<div/>").addClass("f-wm tool-bar").prependTo(i);r.autosize();var f,c=0,m=new Array,p=null,h=!0,u={header:"标题",bold:"加粗",italic:"斜体",link:"超链接","quote-left":"引用",code:"代码块",tag:"标签","list-ol":"有序列表","list-ul":"无序列表",minus:"分割线",image:"图片",table:"表格"};this.createDom=function(){for(var t in u){var s=e("<div/>").addClass("i f-hvc effect fa fa-"+t).attr("type",t).appendTo(l);switch(s.jBox("Tooltip",{content:u[t]}),t){case"header":s.addClass("j-ul-list");var a=e("<ul/>").appendTo(s).addClass("f-bln"),i=["h1","h2","h3","h4","h5","h6"];for(var n in i){var d=e("<li/>").appendTo(a).addClass("effect");d.text(i[n]).attr("type",i[n])}break;case"table":s.addClass("j-table").removeAttr("type");for(var f=e("<table/>").appendTo(s),c=0;6>c;c++)for(var m=e("<tr/>").appendTo(f),p=0;6>p;p++){e("<td/>").appendTo(m).addClass("effect").attr("type","table")}break;case"image":createDropzone(s[0],"http://upload.qiniu.com",o.uploadParams,".jpg,.jpeg,.png,.gif,.ico",function(e,t){r.selection("insert",{text:"\n!["+t.name+"](http://avatar.img.wokugame.com/"+e.name+")",mode:"before"}),r.freshPreview()})}}var s=e("<div/>").addClass("i effect fa fa-maxcdn f-fr").attr("id","markdown-enable").appendTo(l);s.jBox("Tooltip",{content:"markdown 语法支持"})},e(document).on("mouseenter mouseleave",".j-ul-list",function(t){switch(t.type){case"mouseenter":e(this).find("ul").show();break;case"mouseleave":e(this).find("ul").hide()}}),e(document).on("mouseenter mouseleave",".j-table",function(t){switch(t.type){case"mouseenter":e(this).find("table").show();break;case"mouseleave":e(this).find("table").hide()}}),e(document).on("mouseenter mouseleave",".j-table .effect",function(t){var s=this;switch(t.type){case"mouseenter":e(s).parent().parent().find("td").removeClass("active error");var a=e(s).index(),o=e(s).parent().index(),r="active";(0==a||0==o)&&(r="error"),e(s).parent().parent().find("tr:lt("+(o+1)+")").each(function(){e(this).find("td:lt("+(a+1)+")").addClass(r)});break;case"mouseleave":e(s).parent().parent().find("td").removeClass("active error")}}),e(document).on("click",".tool-bar .effect",function(){switch(e(this).attr("type")){case"bold":r.selection("insert",{text:"**",mode:"before"}),r.selection("insert",{text:"**",mode:"after"});break;case"italic":r.selection("insert",{text:"*",mode:"before"}),r.selection("insert",{text:"*",mode:"after"});break;case"link":r.selection("insert",{text:"[",mode:"before"}),r.selection("insert",{text:"](http://)",mode:"after"});break;case"quote-left":r.selection("insert",{text:"> ",mode:"before"});break;case"code":r.selection("insert",{text:"````\n",mode:"before"}),r.selection("insert",{text:"\n````",mode:"after"});break;case"tag":r.selection("insert",{text:"`",mode:"before"}),r.selection("insert",{text:"`",mode:"after"});break;case"list-ol":r.selection("insert",{text:"1. ",mode:"before"});break;case"list-ul":r.selection("insert",{text:"- ",mode:"before"});break;case"minus":var t="\n\n---",s=b(0);""==s&&(t="\n---"),r.selection("insert",{text:t,mode:"before"});break;case"h1":r.selection("insert",{text:"# ",mode:"before"}),r.selection("insert",{text:" #",mode:"after"});break;case"h2":r.selection("insert",{text:"## ",mode:"before"}),r.selection("insert",{text:" ##",mode:"after"});break;case"h3":r.selection("insert",{text:"### ",mode:"before"}),r.selection("insert",{text:" ###",mode:"after"});break;case"h4":r.selection("insert",{text:"#### ",mode:"before"}),r.selection("insert",{text:" ####",mode:"after"});break;case"h5":r.selection("insert",{text:"##### ",mode:"before"}),r.selection("insert",{text:" #####",mode:"after"});break;case"h6":r.selection("insert",{text:"###### ",mode:"before"}),r.selection("insert",{text:" ######",mode:"after"});break;case"table":var a=e(this).index(),o=e(this).parent().index();if(0==a||0==o)break;for(var i="\n",n=0;o+1>n;n++){for(var d=new Array,l=0;a+1>l;l++)d.push(0==n?" `           ":"             ");if(i+=d.join("|")+"\n",0==n){for(var l=0;a+1>l;l++)i+="-----------",l!=a&&(i+="|");i+="\n"}}r.selection("insert",{text:i,mode:"after"})}e(this).is("li")&&e(this).parent().hide(),e(this).is("td")&&e(this).parents("table").first().hide(),r.trigger("autosize.resize"),r.freshPreview()}),t.setOptions({gfm:!0,tables:!0,breaks:!0,pedantic:!1,sanitize:!0,smartLists:!1,silent:!1,langPrefix:"prettyprint",smartypants:!1,headerPrefix:"",xhtml:!1}),this.freshPreview=function(){if(h){if(""==r.val())return r.removeClass("f-w6").addClass("f-w12"),d.hide(),r.trigger("autosize.resize"),void n.css("height","auto");0==c?r.doRender():1==c&&(null!=p&&clearTimeout(p),p=setTimeout(r.doRender,300)),d.height()>500?(r.removeClass("f-w12").addClass("f-w6"),d.removeClass("border-bottom").addClass("border-right"),n.addClass("f-w6 f-drag").removeClass("f-w12"),n.css("height",r.height()+21+"px")):(d.css("margin-top","0px"),r.removeClass("f-w6").addClass("f-w12"),d.removeClass("border-right").addClass("border-bottom"),n.addClass("f-w12").removeClass("f-w6 f-drag"),n.css("height","auto")),d.show(),r.trigger("autosize.resize")}},this.doRender=function(){var a=(new Date).getTime();d.html(t(r.val())),e("pre").addClass("prettyprint pre-scrollable linenums"),s.prettyPrint();var o=(new Date).getTime(),i=0;m.push(o-a),m.length>3&&(i=(m[0]+m[1]+m[2])/3,m=[],i>30&&1>c?(notice("文档过长，切换到延时渲染"),c=1):15>i&&0!=c&&(notice("恢复实时渲染"),c=0))},this.enableMarkdown=function(e){h=e,e?(l.show(),r.addClass("f-btn"),d.show()):(l.hide(),r.removeClass("f-w6").addClass("f-w12"),r.removeClass("f-btn"),d.hide())};var b=function(e){var t=r.selection("getPos").start,s=subStr(r.val(),0,t),a=s.split("\n"),o=a[a.length-e-1];return o};return r.on("keyup keydown",function(e){if(13==e.keyCode&&"keyup"==e.type){var t=b(1);"> "==subStr(t,0,2)&&""!=subStr(t,2,3)&&r.selection("insert",{text:"> ",mode:"before"}),"1. "==subStr(t,0,3)&&""!=subStr(t,3,4)&&r.selection("insert",{text:"1. ",mode:"before"}),"- "==subStr(t,0,2)&&""!=subStr(t,2,3)&&r.selection("insert",{text:"- ",mode:"before"})}"keyup"==e.type&&r.freshPreview()}),n.on("mousedown",function(e){n.hasClass("f-w12")||(f=e.pageY,n.addClass("f-dragging"))}),e(document).on("mouseup",function(){n.hasClass("f-w12")||n.removeClass("f-dragging")}),e(document).on("mousemove",function(e){if(n.hasClass("f-dragging")&&!(d.height()<n.height())){var t=e.pageY-f;f=e.pageY;var s=parseInt(d.css("margin-top").replace("px",""));d.css("margin-top",s+t+"px")}}),e(window).scroll(function(){i.is(":hidden")||h&&(forceHideNav=i.offset().top-e(window).scrollTop()<=30?e(window).scrollTop()-r.offset().top-r.height()>-200?!1:!0:!1,i.offset().top-e(window).scrollTop()<=0?e(window).scrollTop()-r.offset().top-r.height()>-200?l.css("position","absolute").css("top",r.height()+r.offset().top-350+"px"):l.css("position","fixed").css("top","0").css("width",i.width()+1+"px"):l.removeAttr("style"),d.hasClass("f-w6"))}),this},e.fn.MarkEditor.defaults={uploadUrl:"",uploadParams:[]}});