define("mmState",["mmPromise","mmRouter"],function(){function t(t){function e(t,a){var n=t.controller;avalon.vmodels[n]&&avalon.Array.ensure(a,avalon.vmodels[n]),t.parentState&&e(t.parentState,a)}var a=[];return e(t,a),a}function e(t,e,a){t[a]=e[a],delete e[a]}function a(t,e){avalon.state[t]&&avalon.state[t].apply(e||d.currentState,[].slice.call(arguments,2))}function n(t,e){return this instanceof n?(this.stateName=t,this._pending=!1,this.visited=!1,this.params={},this.oldParams={},this.keys=[],avalon.mix(this,e),void 0):new n(t,e||{})}function r(t,e){return"function"==typeof t[e]?t[e]:avalon.noop}function o(t,e,a){for(var n=t&&t.stateName||"",r=e.stateName||"",o=n.split("."),s=r.split("."),l=0,u=o.length;u>l&&o[l]==s[l];l++);if(l==u||l==s.length){if(1>l)return 0/0;if(l==s.length){var v=s;s=o,o=v}for(var p=!0,u=o.length,c=!0;c&&p&&u;)o.splice(u-1),u=o.length,p=i(o.join(".")),p&&(avalon.router._parseArgs(a,p),c=d.isParamsChanged(p.oldParams,p.params));return p||0/0}return i(o.slice(0,l).join("."))}function i(t){for(var e,a=avalon.router.routingTable.get,n=0/0,r=0;e=a[r++];)if(e.stateName===t){n=e;break}return n}function s(t,e){var a=avalon.vmodels[t],n=a&&a.$events.expr||'[ms-controller="'+t+'"]',r=[];if(e.split(".").forEach(function(){r.push("[ms-view]")}),document.querySelectorAll)return document.querySelectorAll(n+" "+r.join(" "));for(var o=Array.prototype.filter.call(document.getElementsByTagName("*"),function(t){return"string"==typeof t.getAttribute("ms-view")});r.length>1;)r.pop(),o=u(o,function(t){return"string"==typeof t.getAttribute("ms-view")});return o=u(o,function(e){return e.getAttribute("avalonctrl")===t||e.getAttribute("ms-controller")===t}),o.map(function(t){return t.node})}function l(t,e){for(var a,n=0;a=t[n++];)if(a.getAttribute("ms-view")===e)return a}function u(t,e){for(var a=0,n=t.length;n>a;a++)v(a,t,e);return t.filter(function(t){return t})}function v(t,e,a){var n=e[t];if(n.node)var r=n.node,o=n.parent;else r=n,o=n.parentNode;for(;o&&9!==o.nodeType;){if(a(o))return e[t]={node:r,parent:o.parentNode};o=o.parentNode}e[t]=!1}function p(t,e){var a=new Promise(function(a,n){var r="function"==typeof t?t(e):t;"string"==typeof r?a(r):n("template必须对应一个字符串或一个返回字符串的函数")});return a}function c(t,e){var a=new Promise(function(a,n){if("function"==typeof t&&(t=t(e)),"string"!=typeof t)return n("templateUrl必须对应一个URL");if(avalon.templateCache[t])return a(avalon.templateCache[t]);var r=g();r.onreadystatechange=function(){if(4===r.readyState){var e=r.status;e>399&&600>e?n("templateUrl对应资源不存在或没有开启 CORS"):a(avalon.templateCache[t]=r.responseText)}},r.open("GET",t,!0),"withCredentials"in r&&(r.withCredentials=!0),r.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.send()});return a}function f(t,e){var a=new Promise(function(a,n){if("function"==typeof t){var r=t(e);r&&r.then?a(r):n("templateProvider为函数时应该返回一个Promise或thenable对象")}else t&&t.then?a(t):n("templateProvider不为函数时应该对应一个Promise或thenable对象")});return a}function m(t,e){return t.template?p(t.template,e):t.templateUrl?c(t.templateUrl,e):t.templateProvider?f(t.templateProvider,e):new Promise(function(t,e){e("必须存在template, templateUrl, templateProvider中的一个")})}function h(t){var e=t.match(/([-\.\w]+)\./)||["",""],a=e[1];if(a){for(var n,r=avalon.router.routingTable.get,o=0;n=r[o++];)if(n.stateName===a)return n;throw new Error("必须先定义["+a+"]")}}avalon.router.route=function(t,e,a,n){e=e.trim();for(var r,o=this.routingTable[t],i=d.currentState,s=0;r=o[s++];){var l=e.match(r.regexp);if(l&&r["abstract"]!==!0){d.query=a||{},r.path=e,r.params={};var u=r.keys;return l.shift(),u.length&&this._parseArgs(l,r),void(r.stateName?d.transitionTo(i,r,l,n):r.callback.apply(r,l))}}this.errorback&&this.errorback()},avalon.router.go=function(t,e,a){var n=d.currentState,r=i(t),o=a&&a.replaceQuery,e=e||{};if(r){r.params&&d.isParamsChanged(r.params,{})||(r.params=avalon.mix({},r.parentState?r.parentState.params||{}:{})),d.query=avalon.mix({},o?{}:d.query||{},e.query||{});var s=r.keys.map(function(t){return e[t.name]||r.params[t.name]||""});avalon.router._parseArgs(s,r),d.transitionTo(n,r,s,a)}};var d=window.mmState={prevState:0/0,currentState:0/0,activeState:0/0,oldQuery:{},query:{},params:{},isParamsChanged:function(t,e){var a=void 0==t,t=a?this.query:t,e=a?this.oldQuery:e,n=!1;for(var r in t)if(!(r in e)||e[r]!=t[r]){n=!0;break}if(!n)for(var r in e)if(!(r in t)||e[r]!=t[r]){n=!0;break}return n&&a&&(this.oldQuery=avalon.mix({},this.query)),n},popState:function(t,e,a){return a=a||avalon.noop,this.activeState&&t!==this.activeState?void this.popOne(t,e,a):a()},popOne:function(t,e,a){var n=this.activeState,r=this;if(t===this.activeState||!n)return a();if(n.onBeforeUnload()===!1)return a(!1);r.activeState=n.parentState||0/0,n.done=function(o){return n._pending=!1,n.done=null,o!==!1&&r.activeState?r.popOne(t,e,a):a(o)};var o=n.onAfterUnload();!n._pending&&n.done&&n.done(o)},pushState:function(t,e,a){a=a||avalon.noop;var n=this.activeState;if(n==t)return a();for(var r=[];t!==n&&t;)r.push(t),t=t.parentState;this.pushOne(r,e,a)},pushOne:function(t,e,a){var n=t.pop(),r=this;return n?n.onBeforeChange()===!1?a(!1):(r.activeState=n,n.done=function(o){return n.done?(n._pending=!1,n.done=null,n.visited=!0,o===!1?(n.callback.apply(n,e),a(o)):void new Promise(function(t){t()}).then(function(){return n.callback.apply(n,e)}).done(function(){r.pushOne(t,e,a)})):void 0},avalon.router._parseArgs(e,n),n.oldParams=avalon.mix({},n.params),n._onChange.apply(n,e),void(!n._pending&&n.done&&n.done())):a()},transitionTo:function(t,e,n,r){var i;this.activeState&&this.activeState!=this.currentState&&(avalon.log("navigating to ["+this.currentState.stateName+"] will be stopped, redirect to ["+e.stateName+"] now"),this.activeState.done&&this.activeState.done(!1),t=this.activeState,i=!0);var s,l=avalon.router.urlFormate(e.url,e.params,d.query),u=this,v=r&&r.reload||this.isParamsChanged(),p=v?0/0:o(t,e,n),c=function(t){s=!0,u.currentState=u.activeState,t!==!1&&(avalon.log("transitionTo "+e.stateName+" success"),a("onload"),avalon.history&&avalon.history.updateLocation(l.path+l.query,avalon.mix({},r||{},{silent:!0})))};if(e.path=("/"+l.path).replace(/^[\/]{2,}/g,"/"),v||t!=e||d.isParamsChanged(e.oldParams,e.params))avalon.log("begin transitionTo "+e.stateName+" from "+(t&&t.stateName||"unknown")),s!==!0&&(this.currentState=e,this.prevState=t,a("begin",this),this.popState(p,n,function(r){return r===!1?c(!1+(p&&p.stateName||"unknown")):(t&&a("unload",t),void u.pushState(e,n,c))}));else if(e==this.activeState&&i)return c()}};avalon.state=function(o,i){var u=h(o),v=n(o,i);if(void 0===v.url&&(v["abstract"]=!0),u&&(v.url=u.url+(v.url||""),v.parentState=u),!v.views){var p={};"template,templateUrl,templateProvider,onBeforeLoad,onAfterLoad".replace(/\w+/g,function(t){e(p,v,t)}),v.views={"":p}}return avalon.router.get(v.url,function(){var e=this,n=(arguments,[]),i=[],u=[],p=t(v),c=p[p.length-1];if(!c)return void avalon.log("topController不存在");c=c.$id;var f=d.prevState&&d.prevState.stateName+".",h=d.currentState,g="viewDefaultInnerHTMLKey",y=null;return avalon.each(v.views,function(t,r){if(t.indexOf("@")>=0)var v=t.split("@"),d=v[0],S=v[1];else var d=t||"",S=o;var w=o+".";if(!f||f===w||0!==f.indexOf(w)||o===h.stateName){var P=s(c,S),b=l(P,d),C="warning: "+o+"状态对象的【"+t+"】视图对象",A=-1;if(avalon.each(P,function(t,e){if(e!==b&&!avalon.contains(b,e)&&(y===e&&(A=t),!y||!(-1===A||A>=t))){var a=avalon(e),n=a.data(g);n&&(avalon.innerHTML(e,n),avalon.scan(e,p))}}),b){d||(y=b);var N=avalon(b).data(g);null===N&&avalon(b).data(g,b.innerHTML);var T=m(r,e.params);i.push(b),u.push(function(){T.then(function(t){avalon.innerHTML(b,t),avalon.scan(b,p)},function(n){avalon.log(C+" "+n),a("onloadError",e,t)})}),n.push(T)}else avalon.log(C+"对应的元素节点不存在")}}),r(v,"onBeforeLoad").call(i,e),avalon.each(u,function(t,e){e()}),Promise.all(n).then(function(){r(v,"onAfterLoad").call(i,e)})},v),this},avalon.state.config=function(t){avalon.mix(avalon.state,t||{})},n.prototype={paramsChanged:function(){var t=d.isParamsChanged(this.oldParams,this.params);return t&&(this.oldParams=avalon.mix({},this.params)),t},_onChange:function(){this.query=this.getQuery(),this.onChange.apply(this,arguments)},getQuery:function(){return d.query},getParams:function(){return this.params},async:function(){return this.done&&(this._pending=!0),this.done||avalon.noop},onBeforeChange:avalon.noop,onChange:avalon.noop,onBeforeLoad:avalon.noop,onAfterLoad:avalon.noop,onBeforeUnload:avalon.noop,onAfterUnload:avalon.noop};var g=function(){return new(window.XMLHttpRequest||ActiveXObject)("Microsoft.XMLHTTP")}});