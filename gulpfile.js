/**
 * 环境要求
 * 最新版 nodejs
 * 全局安装
 * npm install gulp -g
 * 目录安装
 * npm install gulp --save-dev
 * 组件安装
 * npm install gulp-util gulp-imagemin gulp-sass gulp-htmlmin gulp-minify-css gulp-jshint gulp-uglify gulp-rename gulp-concat del gulp-livereload tiny-lr --save-dev
 */

///////////////////////////////////////////////////////////////////////////////////////////////
// 引入 gulp及组件
///////////////////////////////////////////////////////////////////////////////////////////////
var gulp = require('gulp'), //基础库
	imagemin = require('gulp-imagemin'), //图片压缩
	htmlmin = require('gulp-htmlmin'), //html压缩
	sass = require('gulp-sass'), //sass
	minifycss = require('gulp-minify-css'), //css压缩
	jshint = require('gulp-jshint'), //js检查
	uglify = require('gulp-uglify'), //js压缩
	rename = require('gulp-rename'), //重命名
	concat = require('gulp-concat'), //合并文件
	del = require('del'); //删除文件

///////////////////////////////////////////////////////////////////////////////////////////////
// 路径
///////////////////////////////////////////////////////////////////////////////////////////////
var paths = {
	src: {
		html: 'src/html/**/*.html',
		css: 'src/scss/**/*.scss',
		js: 'src/js/**/*.js'
	},
	dist: {
		html: 'static/html',
		css: 'static/css',
		js: 'static/js'
	}
};

///////////////////////////////////////////////////////////////////////////////////////////////
// HTML处理
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('html', function () {
	return gulp.src(paths.src.html)
		//.pipe(htmlmin({
		//	collapseWhitespace: true
		//}))
		.pipe(gulp.dest(paths.dist.html));
});

///////////////////////////////////////////////////////////////////////////////////////////////
// 所有样式合并
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('css', function () {
	return gulp.src(paths.src.css)
		.pipe(concat('all.css')) //文件合并
		.pipe(sass())
		.pipe(minifycss())
		.pipe(gulp.dest(paths.dist.css));
});

///////////////////////////////////////////////////////////////////////////////////////////////
// js合并处理
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('js', function () {
	return gulp.src(paths.src.js)
		//.pipe(uglify())
		.pipe(gulp.dest(paths.dist.js));
});

///////////////////////////////////////////////////////////////////////////////////////////////
// 清空模版、样式、js
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('clean', function (cb) {
	del([paths.dist.html, paths.dist.css, paths.dist.js], cb);
});

///////////////////////////////////////////////////////////////////////////////////////////////
// 监听任务 运行语句 gulp watch
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('watch', function () {
	// 监听html
	gulp.watch(paths.src.html, ['html'])

	// 监听css
	gulp.watch(paths.src.css, ['css']);

	// 监听js
	gulp.watch(paths.src.js, ['js']);
});

///////////////////////////////////////////////////////////////////////////////////////////////
// 默认任务 清空模版、样式、js并重建 运行语句 gulp
///////////////////////////////////////////////////////////////////////////////////////////////
gulp.task('default', ['clean'], function () {
	gulp.start('html', 'css', 'js', 'watch');
});